-- Fix RLS policies for profiles to handle users with multiple schools
-- This extends the previous recursion fix to support provider_schools table

-- Drop existing function and policy
DROP POLICY IF EXISTS "Users can view team members in same school" ON profiles;
DROP FUNCTION IF EXISTS public.get_user_school_id();

-- Create an improved security definer function that returns all school IDs for a user
CREATE OR REPLACE FUNCTION public.get_user_school_ids()
RETURNS TABLE(school_id varchar)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
STABLE
AS $$
BEGIN
    RETURN QUERY
    -- Get the user's primary school from profiles
    SELECT p.school_id
    FROM profiles p
    WHERE p.id = auth.uid() AND p.school_id IS NOT NULL
    
    UNION
    
    -- Get additional schools from provider_schools
    SELECT ps.school_id
    FROM provider_schools ps
    WHERE ps.provider_id = auth.uid() AND ps.school_id IS NOT NULL;
END;
$$;

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION public.get_user_school_ids() TO authenticated;

-- Create a non-recursive policy that handles multiple schools
CREATE POLICY "Users can view team members in their schools" 
ON profiles
FOR SELECT 
USING (
    -- Allow users to view their own profile
    auth.uid() = id
    OR
    -- Allow viewing profiles in any of the user's schools
    (school_id IS NOT NULL AND school_id IN (SELECT * FROM public.get_user_school_ids()))
);

-- Ensure the profiles table has RLS enabled
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- Add comments
COMMENT ON FUNCTION public.get_user_school_ids() IS 
'Security definer function that returns all school IDs for the current user, including primary and additional schools from provider_schools table.';

COMMENT ON POLICY "Users can view team members in their schools" ON profiles IS 
'Non-recursive policy that allows users to view profiles of team members at any school they work at, using a security definer function to avoid infinite recursion.';